---
layout: post
title: 6.828 Lab1
categories: OS
description: 6.828 Lab1 笔记
keywords: OS, 6.828
---

## 前言
### 工具链
用 Ubuntu 比较方便:  
```bash
sudo apt install -y gcc objdump
sudo apt install -y build-essential gdb
sudo apt install -y gcc-multilib
sudo apt install -y qemu
```

### 软件配置
首先是 git 的部署和基本用法.  
然后是整个项目的 Makefile. 使用 `make handin` 可以提交, 但是我不是 MIT 的学生; `make grade` 可以测成绩.   

## 第一部分: PC 引导
### x86 汇编
汇编已经在上上一篇博文里完成了. 不过因为 828 全程用到 gcc, 所以汇编自然是 AT&T 风格的, 区别于 NASM.  

### 模拟 x86
```bash
make
```
输出:  
```
+ as kern/entry.S
+ cc kern/entrypgdir.c
+ cc kern/init.c
+ cc kern/console.c
+ cc kern/monitor.c
+ cc kern/printf.c
+ cc kern/kdebug.c
+ cc lib/printfmt.c
+ cc lib/readline.c
+ cc lib/string.c
+ ld obj/kern/kernel
ld: warning: section `.bss' type changed to PROGBITS
+ as boot/boot.S
+ cc -Os boot/main.c
+ ld boot/boot
boot block is 390 bytes (max 510)
+ mk obj/kern/kernel.img
```
bss 段报了个警告, 但是问题不大.  

用 `make qemu` 或者 `make qemu-nox` 可以放 QEMU 里面跑.  
系统自带两个指令, `help` 和 `kerninfo`. `C-A,X` 可以退出 QEMU.  

### PC 的物理地址空间
```
+------------------+  <- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  <- depends on amount of RAM
|                  |
|                  |
| Extended Memory  |
|                  |
|                  |
+------------------+  <- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  <- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  <- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  <- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  <- 0x00000000
```
注意, JOS 被限制只用 PC 物理地址的前 256MB.  

### The ROM BIOS
在第一个终端里执行 `make qemu-gdb` 或者 `make qemu-nox-gdb`, QEMU 会停在处理器执行第一个指令之前. 接着在第二个终端里输入 `make gdb` 可以对 QEMU 里的系统进行调试.  

接着, 可以跟踪到第一条指令是:  
```
[f000:fff0]    0xffff0:	ljmp   $0x3630,$0xf000e05b
```
这里 CS = $0x3630, IP = $0xf000e05b. 
原文这里是 `[f000:fff0] 0xffff0:	ljmp   $0xf000,$0xe05b`. 
